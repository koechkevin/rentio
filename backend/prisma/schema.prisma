generator client {
  provider = "prisma-client-js"
  binaryTargets = ["debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum GlobalRole {
  ADMIN
  USER
}

enum PropertyRole {
  OWNER
  CARETAKER
  TENANT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum UnitType {
  BEDSITTER
  ONE_BEDROOM
  TWO_BEDROOM
  THREE_BEDROOM
  SHOP
  OFFICE
  OTHER
}

enum UnitStatus {
  VACANT
  OCCUPIED
  MAINTENANCE
}

enum PaymentType {
  RENT
  DEPOSIT
  PENALTY
  UTILITY
  OTHER
}

enum PaymentMethod {
  MPESA
  BANK_TRANSFER
  CASH
  CHEQUE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

enum IssueCategory {
  PLUMBING
  ELECTRICAL
  CARPENTRY
  PAINTING
  SECURITY
  OTHER
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model User {
  id                String              @id @default(cuid())
  email             String              @unique
  displayPicture    String?
  backgroundPicture String?
  about             String?             @db.Text
  website           String?
  fullName    String     @map("full_name")
  nationalId  String?    @unique @map("national_id")
  phone       String     @unique
  password    String
  globalRole  GlobalRole @default(USER) @map("global_role")
  status      UserStatus @default(ACTIVE)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  deletedAt   DateTime?  @map("deleted_at")
  verificationCode      String?
  isEmailVerified       Boolean     @default(false)
  verificationCodeExpiresAt DateTime?

  ownedProperties   Property[]           @relation("PropertyOwner")
  userPropertyRoles UserPropertyRole[]   @relation("UserPropertyRoles")
  assignedRoles     UserPropertyRole[]   @relation("AssignedRoles")
  leases            Lease[]
  issues            Issue[]
  auditLogs         AuditLog[]

  activities        UserActivity[]
  tenancyAgreements TenancyAgreement[]
  uploads           Upload[]
  invoicesAsCustomer Invoice[]       @relation("InvoiceCustomer")
  invoicesAsCreator  Invoice[]       @relation("InvoiceCreator")
  paymentsCreated    Payment[]       @relation("PaymentCreator")

  @@map("users")
}

model UserPropertyRole {
  id         String        @id @default(uuid())
  userId     String        @map("user_id")
  propertyId String        @map("property_id")
  role       PropertyRole  
  assignedBy String        @map("assigned_by")
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")
  removedAt  DateTime?     @map("removed_at")

  user           User     @relation("UserPropertyRoles", fields: [userId], references: [id], onDelete: Cascade)
  property       Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  assignedByUser User     @relation("AssignedRoles", fields: [assignedBy], references: [id])

  @@unique([userId, propertyId, role])
  @@index([userId])
  @@index([propertyId])
  @@map("property_roles")
}

model Property {
  id                      String    @id @default(uuid())
  ownerId                 String    @map("owner_id")
  name                    String
  slug                    String    @unique
  ownerProvidedIdentifier String?   @map("owner_provided_identifier")
  county                  String
  town                    String
  gpsLatitude             Float?    @map("gps_latitude")
  gpsLongitude            Float?    @map("gps_longitude")
  baseCurrency            String    @default("KES") @map("base_currency")
  isMarketable            Boolean   @default(false) @map("is_marketable")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")
  deletedAt               DateTime? @map("deleted_at")

  owner             User                @relation("PropertyOwner", fields: [ownerId], references: [id])
  userPropertyRoles UserPropertyRole[]
  units             Unit[]
  auditLogs         AuditLog[]
  subscription      PropertySubscription?
  invoices          Invoice[]            @relation("InvoiceProperty")

  @@index([slug])
  @@index([ownerId])
  @@map("properties")
}

model PropertySubscription {
  id                String                 @id @default(uuid())
  propertyId        String                 @unique @map("property_id")
  paidUnits         Int                    @default(0) @map("paid_units")
  usedUnits         Int                    @default(0) @map("used_units")
  pricePerUnit      Decimal                @default(500) @map("price_per_unit") @db.Decimal(10, 2)
  currency          String                 @default("KES")
  status            SubscriptionStatus     @default(ACTIVE)
  lastPaymentDate   DateTime?              @map("last_payment_date")
  nextBillingDate   DateTime?              @map("next_billing_date")
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")

  property          Property               @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  payments          SubscriptionPayment[]

  @@index([propertyId])
  @@index([status])
  @@map("property_subscriptions")
}

model SubscriptionPayment {
  id               String               @id @default(uuid())
  subscriptionId   String               @map("subscription_id")
  amount           Decimal              @db.Decimal(12, 2)
  unitsCount       Int                  @map("units_count")
  paymentMethod    PaymentMethod        @default(MPESA)
  reference        String?
  mpesaReceipt     String?              @map("mpesa_receipt")
  status           PaymentStatus        @default(PENDING)
  paidAt           DateTime?            @map("paid_at")
  validFrom        DateTime             @map("valid_from")
  validUntil       DateTime             @map("valid_until")
  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")

  subscription     PropertySubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@map("subscription_payments")
}

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  CANCELLED
}

model Unit {
  id          String     @id @default(uuid())
  propertyId  String     @map("property_id")
  unitNumber  String     @map("unit_number")
  type        UnitType
  monthlyRent Decimal    @map("monthly_rent") @db.Decimal(12, 2)
  status      UnitStatus @default(VACANT)
  floor       Int?
  photos      String[]
  description String?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  deletedAt   DateTime?  @map("deleted_at")

  property         Property          @relation(fields: [propertyId], references: [id])
  leases           Lease[]
  issues           Issue[]
  marketingListing MarketingListing?
  invoices         Invoice[]         @relation("InvoiceUnit")

  @@unique([propertyId, unitNumber])
  @@index([propertyId])
  @@map("units")
}

model Lease {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  unitId      String    @map("unit_id")
  leaseStart  DateTime  @map("lease_start")
  leaseEnd    DateTime? @map("lease_end")
  agreedRent  Decimal   @map("agreed_rent") @db.Decimal(12, 2)
  deposit     Decimal   @db.Decimal(12, 2)
  active      Boolean   @default(true)
  rating      Int?
  feedback    String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  terminatedAt DateTime? @map("terminated_at")

  user     User      @relation(fields: [userId], references: [id])
  unit     Unit      @relation(fields: [unitId], references: [id])
  payments Payment[]
  issues   Issue[]

  @@index([userId])
  @@index([unitId])
  @@index([active])
  @@map("leases")
}

model Payment {
  id               String              @id @default(uuid())
  leaseId          String              @map("lease_id")
  amount           Decimal             @db.Decimal(12, 2)
  allocatedAmount  Decimal             @default(0) @map("allocated_amount") @db.Decimal(12, 2)
  unallocatedAmount Decimal            @default(0) @map("unallocated_amount") @db.Decimal(12, 2)
  type             PaymentType
  method           PaymentMethod
  mpesaReceipt     String?             @map("mpesa_receipt")
  reference        String?
  status           PaymentStatus       @default(PENDING)
  isProcessed      Boolean             @default(false) @map("is_processed")
  paidAt           DateTime?           @map("paid_at")
  createdBy        String?             @map("created_by")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")

  lease            Lease               @relation(fields: [leaseId], references: [id])
  createdByUser    User?               @relation("PaymentCreator", fields: [createdBy], references: [id])
  allocations      PaymentAllocation[]

  @@index([leaseId])
  @@index([status])
  @@map("payments")
}

model Issue {
  id          String        @id @default(uuid())
  leaseId     String        @map("lease_id")
  unitId      String        @map("unit_id")
  reportedBy  String        @map("reported_by")
  category    IssueCategory
  title       String
  description String
  status      IssueStatus   @default(OPEN)
  priority    IssuePriority @default(MEDIUM)
  photos      String[]
  resolvedAt  DateTime?     @map("resolved_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  lease        Lease @relation(fields: [leaseId], references: [id])
  unit         Unit  @relation(fields: [unitId], references: [id])
  reportedByUser User  @relation(fields: [reportedBy], references: [id])

  @@index([leaseId])
  @@index([unitId])
  @@index([status])
  @@map("issues")
}

model MarketingListing {
  id          String    @id @default(uuid())
  unitId      String    @unique @map("unit_id")
  active      Boolean   @default(true)
  price       Decimal   @db.Decimal(12, 2)
  viewsCount  Int       @default(0) @map("views_count")
  publishedAt DateTime? @map("published_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  unit Unit @relation(fields: [unitId], references: [id])

  @@index([active])
  @@map("marketing_listings")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  propertyId String   @map("property_id")
  action     String
  entity     String
  entityId   String   @map("entity_id")
  changes    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id])
  property Property @relation(fields: [propertyId], references: [id])

  @@index([userId])
  @@index([propertyId])
  @@index([createdAt])
  @@map("audit_logs")
}

model UserActivity {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activityType ActivityType
  description  String
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

enum ActivityType {
  LOCATION_CHANGE
  DOCUMENT_UPLOAD
  PROPERTY_ADDITION
  PROFILE_UPDATE
}

model TenancyAgreement {
  id                 String          @id @default(cuid())
  userId             String
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId         String
  startDate          DateTime
  endDate            DateTime
  rentAmount         Float
  rentFrequency      RentFrequency   @default(MONTHLY)
  agreementDocument  String?
  status             TenancyStatus   @default(ACTIVE)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@index([userId])
  @@index([status])
}

enum RentFrequency {
  MONTHLY
  QUARTERLY
  ANNUALLY
}

enum TenancyStatus {
  ACTIVE
  EXPIRED
  TERMINATED
}

model Upload {
  id            String         @id @default(uuid())
  filename      String
  originalName  String
  mimeType      String
  size          Int
  url           String
  uploadedById  String
  uploadedBy    User           @relation(fields: [uploadedById], references: [id])
  entityUploads EntityUpload[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@map("uploads")
}

model EntityUpload {
  id         String   @id @default(uuid())
  uploadId   String
  upload     Upload   @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  entityType String
  entityId   String
  isPrimary  Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([uploadId, entityType, entityId])
  @@index([entityType, entityId])
  @@map("entity_uploads")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum BillingDuration {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  ONE_TIME
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique @map("invoice_number")
  customerId    String        @map("customer_id")
  propertyId    String        @map("property_id")
  unitId        String        @map("unit_id")
  totalAmount   Decimal       @map("total_amount") @db.Decimal(12, 2)
  vatAmount     Decimal       @map("vat_amount") @db.Decimal(12, 2)
  subTotal      Decimal       @map("sub_total") @db.Decimal(12, 2)
  vatRate       Decimal       @default(16) @map("vat_rate") @db.Decimal(5, 2)
  dueDate       DateTime      @map("due_date")
  issueDate     DateTime      @default(now()) @map("issue_date")
  status        InvoiceStatus @default(DRAFT)
  notes         String?       @db.Text
  createdBy     String        @map("created_by")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  deletedAt     DateTime?     @map("deleted_at")

  customer      User           @relation("InvoiceCustomer", fields: [customerId], references: [id])
  property      Property       @relation("InvoiceProperty", fields: [propertyId], references: [id])
  unit          Unit           @relation("InvoiceUnit", fields: [unitId], references: [id])
  createdByUser User           @relation("InvoiceCreator", fields: [createdBy], references: [id])
  items         InvoiceItem[]
  allocations   PaymentAllocation[]

  @@index([customerId])
  @@index([propertyId])
  @@index([unitId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceNumber])
  @@map("invoices")
}

model PaymentAllocation {
  id              String   @id @default(uuid())
  paymentId       String   @map("payment_id")
  invoiceId       String   @map("invoice_id")
  amount          Decimal  @db.Decimal(12, 2)
  createdAt       DateTime @default(now()) @map("created_at")

  payment         Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([invoiceId])
  @@map("payment_allocations")
}

model InvoiceItem {
  id              String          @id @default(uuid())
  invoiceId       String          @map("invoice_id")
  itemName        String          @map("item_name")
  itemDescription String?         @map("item_description") @db.Text
  unitAmount      Decimal         @map("unit_amount") @db.Decimal(12, 2)
  quantity        Decimal         @default(1) @db.Decimal(10, 2)
  billingDuration BillingDuration @map("billing_duration")
  billingPeriod   DateTime?       @map("billing_period")
  total           Decimal         @db.Decimal(12, 2)
  vatable         Boolean         @default(false)
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([billingPeriod])
  @@map("invoice_items")
}
